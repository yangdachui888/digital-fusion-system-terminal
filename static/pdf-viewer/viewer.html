<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>PDF Viewer</title>
    <style>
        /* 确保内容铺满且无滚动条 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #f0f0f0; /* 背景色，防止闪烁 */
        }
        #pdf-container {
            width: 100%;
            height: 100%;
            overflow-y: auto; /* 允许垂直滚动查看所有页面 */
            text-align: center; /* 让canvas居中 */
        }
        canvas {
            display: block;
            margin: 10px auto; /* 页面之间留出一些间距 */
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="pdf-container"></div>

    <!-- 引入pdf.js核心库 -->
    <script src="./build/pdf.js"></script>

    <script>
        // 1. 定义一个辅助函数来获取URL查询参数
        function getQueryVariable(variable) {
            const query = window.location.search.substring(1);
            const vars = query.split("&");
            for (let i = 0; i < vars.length; i++) {
                const pair = vars[i].split("=");
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }

        // 2. 从URL获取所有需要的参数，并提供默认值
        const pdfUrl = getQueryVariable('file');
        const autoPlayInterval = parseInt(getQueryVariable('interval'), 10) || 0; // 自动播放间隔，0表示不自动播放
        const scale = parseFloat(getQueryVariable('scale')) || 1.5; // 渲染比例，默认为1.5

        const container = document.getElementById('pdf-container');

        // 3. 核心PDF加载与渲染逻辑
        if (pdfUrl) {
            // 设置PDF.js的worker路径，这对性能至关重要
            pdfjsLib.GlobalWorkerOptions.workerSrc = `./build/pdf.worker.js`;

            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            loadingTask.promise.then(function(pdfDoc) {
                console.log('PDF document loaded successfully. Total pages:', pdfDoc.numPages);

                // 封装的页面渲染函数
                const renderPage = (pageNum) => {
                    return pdfDoc.getPage(pageNum).then(function(page) {
                        const viewport = page.getViewport({ scale: scale });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        page.render({
                            canvasContext: context,
                            viewport: viewport
                        });
                        
                        container.appendChild(canvas);
                    });
                };

                if (autoPlayInterval > 0) {
                    // --- 自动播放逻辑 ---
                    let currentPageNum = 1;
                    const renderNextPage = () => {
                        if (currentPageNum <= pdfDoc.numPages) {
                            renderPage(currentPageNum).then(() => {
                                // 滚动到新渲染的页面
                                container.scrollTop = container.scrollHeight;
                            });
                            currentPageNum++;
                        } else {
                            console.log('All pages rendered. Stopping auto-play.');
                            clearInterval(intervalId);
                        }
                    };
                    const intervalId = setInterval(renderNextPage, autoPlayInterval);
                    renderNextPage(); // 立即渲染第一页
                } else {
                    // --- 一次性渲染所有页面逻辑 ---
                    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                        renderPage(pageNum);
                    }
                }

            }, function(reason) {
                console.error('Error loading PDF: ' + reason);
                container.textContent = 'PDF文件加载失败: ' + (reason.message || reason);
            });
        } else {
            container.textContent = '没有提供PDF文件地址。';
        }
    </script>
</body>
</html>